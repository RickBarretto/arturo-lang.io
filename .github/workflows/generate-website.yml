name: Update

on:
    pull_request:
    workflow_dispatch:
 
concurrency: 
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    # Step 1: Auto-increment build number
    Build:
        runs-on: ubuntu-latest
        permissions:
            contents: write
        outputs:
            version_tag: ${{ steps.version-info.outputs.VERSION_TAG }}

        steps:
            # - name: Checkout code
            #   uses: actions/checkout@v3
            #   with:
            #     ref: master
            #     fetch-depth: 0
            #     token: ${{ secrets.PAT_TOKEN }}
      
            - name: Increment build number and get version info
              id: version-info
              run: |
                version_tag="nightly.20251223"
                echo "VERSION_TAG=${version_tag}" >> "$GITHUB_OUTPUT"

            # - name: Configure Git
            #   run: |
            #     git config user.name "GitHub Actions Bot"
            #     git config user.email "actions@github.com"
      
            # - name: Increment build number and get version info
            #   id: version-info
            #   run: |
            #     # Read current build number
            #     current_build=$(cat version/build)
                
            #     # Increment it
            #     new_build=$((current_build + 1))
                
            #     # Update file
            #     echo $new_build > version/build
                
            #     # Read version
            #     if [ -f "version/version" ]; then
            #         version=$(cat version/version)
            #     else 
            #         version=$(git describe --tags --abbrev=0 2>/dev/null || echo "0.9.83")
            #     fi
                
            #     # Create version tag (format: master.abc1234)
            #     git_hash=$(git rev-parse --short HEAD)
            #     version_tag="master.${git_hash}"
            #     echo "VERSION_TAG=${version_tag}" >> "$GITHUB_OUTPUT"
                
            #     echo "New build number: $new_build"
            #     echo "Version tag: $version_tag"
                
            #     # Commit and push
            #     git add version/build
            #     git commit -m "Update build to ${new_build}"
            #     git push origin master

    #Step 2: Build all binaries with new version
    Binaries:
        runs-on: ${{ 
            (matrix.os == 'linux')   && (matrix.support == 'legacy' && (matrix.arch == 'arm64' && 'ubuntu-22.04-arm' || 'ubuntu-22.04') || matrix.arch == 'arm64' && 'ubuntu-24.04-arm' || 'ubuntu-latest') ||
            (matrix.os == 'macos')   && (matrix.arch == 'arm64' && 'macos-latest' || 'macOS-15-intel') ||
            (matrix.os == 'windows') && 'windows-latest' || 
                                        'ubuntu-latest'  }}
        needs: Build
        strategy:
            matrix:
                include: 
                    - {os: linux,   arch: amd64, mode: full}
                    - {os: linux,   arch: amd64, mode: full, support: legacy}
                    - {os: linux,   arch: amd64, mode: mini}
                    - {os: linux,   arch: arm64, mode: full}
                    - {os: linux,   arch: arm64, mode: full, support: legacy}
                    - {os: linux,   arch: arm64, mode: mini}
                    - {os: freebsd, arch: amd64, mode: full}
                    - {os: freebsd, arch: amd64, mode: mini}
                    - {os: macos,   arch: amd64, mode: full}
                    - {os: macos,   arch: amd64, mode: mini}
                    - {os: macos,   arch: arm64, mode: full}
                    - {os: macos,   arch: arm64, mode: mini}
                    - {os: windows, arch: amd64, mode: full}
                    - {os: windows, arch: amd64, mode: mini}
                    - {os: web}

        name: Build ${{ matrix.os }}-${{ matrix.arch || 'js' }}-${{ matrix.mode || 'mini' }}${{ matrix.support == 'legacy' && '-legacy' || '' }}
        defaults:
            run:
                shell: ${{ 
                    (matrix.os == 'freebsd') && 'freebsd {0}' ||
                    (matrix.os == 'windows') && 'msys2 {0}'   || 
                                                'bash'        }}
        steps:
            - name: Install Arturo
              uses: arturo-lang/arturo-action@main
              with: 
                do: fetch
                token: ${{ secrets.GITHUB_TOKEN }}
                os: ${{ matrix.os }}
                arch: ${{ matrix.arch }}
                mode: ${{ matrix.mode }}
                support: ${{ matrix.support }}
                #src: ${{ github.ref }}
                metadata: ${{ needs.Build.outputs.version_tag }}
                create_artifact: 'true'
                artifacts_only: 'true'
                #artifact_version: ${{ needs.Build.outputs.version_tag }}

    # Step 3: Generate documentation and combine with binaries
    Documentation:
        runs-on: ubuntu-latest
        name: Generate Documentation & Deploy
        needs: [Build, Binaries]
        defaults:
            run:
                shell: bash
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                fetch-depth: 0

            - name: Install Arturo
              uses: arturo-lang/arturo-action@v2
              with: 
                do: compile
                mode: docgen
                token: ${{ secrets.GITHUB_TOKEN }}
                metadata: ${{ needs.Build.outputs.version_tag }}

            - name: "Install Node"
              uses: actions/setup-node@v4
              with:
                node-version: latest

            - name: "Install Ruby"
              uses: ruby/setup-ruby@v1
              with:
                ruby-version: 3.3
                bundler-cache: true

            - name: "Install build dependencies"
              run: |
                sudo apt-get update
                sudo apt-get install -y build-essential libcmocka-dev webp \
                                        pandoc texlive-latex-base texlive-fonts-recommended \
                                        texlive-extra-utils texlive-latex-extra
                
                sudo npm install -g sass uglify-js

            - name: Download artifacts
              uses: dawidd6/action-download-artifact@v11
              with:
                github_token: ${{ secrets.GITHUB_TOKEN }}
                run_id: ${{ github.run_id }}
                path: ./files
                skip_unpack: true

            - name: Checkout examples repository
              uses: actions/checkout@v4
              with:
                repository: arturo-lang/examples
                path: examples

            - name: "Generate website"
              env:
                VERSION_TAG: ${{ needs.Build.outputs.version_tag }}
              run: |
                arturo tools/binarygen.art  "$VERSION_TAG" latest
                arturo tools/sitegen.art
                arturo tools/indexgen.art
                arturo tools/preprocessjs.art \
                  --basePath:"latest" \
                  --keywordPredicates:"$(arturo tools/getbuiltins.art 1)" \
                  --keywordRest:"$(arturo tools/getbuiltins.art 2)"

                mv details.art src/data/setup.art
                rm -rf tmpdocs  # Remove if exists
                mkdir -p tmpdocs
                cd src
                arturo ../tools/miniwebize/webize.art --build --at: ../tmpdocs
                cd ..
                mkdir -p tmpdocs/backend
                cp -r src/backend/* tmpdocs/backend/
                mkdir -p tmpdocs/scripts
                cp -r src/scripts/* tmpdocs/scripts
                arturo tools/genaiguide.art
                mv tools/aiguide.md tmpdocs/llms.txt

            - name: Generate tutorial
              run: |
                sed 's/[^\x00-\x7F]//g' tmpdocs/llms.txt | pandoc -f gfm -t pdf -o tmpdocs/tutorial.pdf

            - name: Copy binaries to website
              run: |
                # Create binaries directory in website output
                mkdir -p tmpdocs/files
                
                # Copy all binary zips
                echo "Copying binaries..."
                cp files/*.zip tmpdocs/files/
                
                # Create version file
                echo "${{ needs.Build.outputs.version_tag }}" > tmpdocs/files/VERSION
                
                # Verify binaries were copied
                echo "Binaries in tmpdocs:"
                ls -lh tmpdocs/files/
                
            - name: Synchronize to website
              uses: burnett01/rsync-deployments@7.0.2
              with:
                switches: -avzr --delete
                path: tmpdocs/
                remote_path: /usr/local/www/arturo/main/versions/latest
                remote_host: 188.245.97.105 
                remote_user: web
                remote_key: ${{ secrets.FREEBSD_DEPLOYMENT }}

            - name: Extract and move FreeBSD binary
              uses: appleboy/ssh-action@v1.2.0
              with:
                host: 188.245.97.105
                username: web
                key: ${{ secrets.FREEBSD_DEPLOYMENT }}
                script: |
                  cd /usr/local/www/arturo/main/versions/latest
                
                  # Download just the files as a tarball, extract directly
                  mkdir -p examples
                  
                  curl -L https://github.com/arturo-lang/examples/archive/refs/heads/main.tar.gz | \
                      tar xz --strip-components=1 -C examples/

                  unzip -o files/*-freebsd-amd64.zip
                  mkdir -p bin
                  mv arturo bin/
                  chmod +x scripts/setup_runner.sh
                  sudo /usr/local/sbin/arturo_setup_runner latest
 
            - name: Upload complete website artifact
              uses: 'actions/upload-artifact@v4'
              with:
                name: website-with-binaries-${{ needs.Build.outputs.version_tag }}
                path: tmpdocs

            - name: Display completion summary
              run: |
                echo "ðŸŽ‰ Build & Documentation Complete!"
                echo "Version: ${{ needs.Build.outputs.version_tag }}"
                echo "Binaries built: $(ls files/ | wc -l)"
                echo "Website deployed to: https://188.245.97.105 /latest"
                echo "Binaries available at: https://188.245.97.105/latest/files"