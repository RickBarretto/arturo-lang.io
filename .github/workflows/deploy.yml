name: Deploy Website

on:
    workflow_call: &workflow_config
        inputs:
            channel:
                description: 'Channel: latest (nightly), stable (release), or current (from run)'
                required: true
                type: string
            tag:
                description: 'Custom version tag (only for current channel, defaults to commit SHA)'
                required: false
                type: string

    workflow_dispatch: *workflow_config

jobs:
    Deploy:
        runs-on: ubuntu-latest
        name: Generate Documentation & Deploy
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                fetch-depth: 0

            - name: "Install Node"
              uses: actions/setup-node@v4
              with:
                node-version: latest

            - name: "Install Ruby"
              uses: ruby/setup-ruby@v1
              with:
                ruby-version: 3.3
                bundler-cache: true

            - name: "Install build dependencies"
              run: |
                sudo apt-get update
                sudo apt-get install -y build-essential libcmocka-dev webp \
                                        pandoc texlive-latex-base texlive-fonts-recommended \
                                        texlive-extra-utils texlive-latex-extra
                
                sudo npm install -g sass uglify-js

            - name: Download binaries from release
              if: inputs.channel != 'current'
              id: download
              run: |
                mkdir -p files
                
                # Determine repository based on channel
                if [ "${{ inputs.channel }}" = "stable" ]; then
                    REPO="arturo-lang/arturo"
                    echo "ðŸ“¦ Downloading from stable release (arturo-lang/arturo)..."
                else
                    REPO="arturo-lang/nightly"
                    echo "ðŸ“¦ Downloading from nightly release (arturo-lang/nightly)..."
                fi
                
                # Get latest release
                LATEST_RELEASE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                  "https://api.github.com/repos/${REPO}/releases/latest" | \
                  jq -r '.tag_name')
                
                if [ -z "$LATEST_RELEASE" ] || [ "$LATEST_RELEASE" = "null" ]; then
                    echo "âŒ ERROR: Could not find latest release in $REPO"
                    exit 1
                fi
                
                echo "âœ… Latest release: $LATEST_RELEASE"
                echo "release_tag=$LATEST_RELEASE" >> $GITHUB_OUTPUT
                
                # Download all assets from the release
                ASSETS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                  "https://api.github.com/repos/${REPO}/releases/latest" | \
                  jq -r '.assets[].browser_download_url')
                
                echo "ðŸ“¥ Downloading release assets..."
                for asset_url in $ASSETS; do
                    filename=$(basename "$asset_url")
                    echo "  - $filename"
                    curl -fsSL -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                      "$asset_url" -o "files/$filename"
                done
                
                # Extract version from first zip file
                FIRST_ZIP=$(ls files/*.zip | head -1)
                if [ -z "$FIRST_ZIP" ]; then
                    echo "âŒ ERROR: No zip files found in release"
                    exit 1
                fi
                
                # Extract version part: arturo-VERSION-os-arch.zip -> VERSION
                VERSION=$(basename "$FIRST_ZIP" .zip | cut -d- -f2)
                echo "version_tag=$VERSION" >> $GITHUB_OUTPUT
                echo "âœ… Detected version: $VERSION"
              shell: bash

            - name: Download artifacts from workflow run
              if: inputs.channel == 'current'
              uses: dawidd6/action-download-artifact@v11
              with:
                github_token: ${{ secrets.GITHUB_TOKEN }}
                run_id: ${{ github.run_id }}
                path: ./files
                skip_unpack: true

            - name: Determine version for current channel
              if: inputs.channel == 'current'
              id: current_version
              run: |
                if [ -n "${{ inputs.tag }}" ]; then
                    VERSION="${{ inputs.tag }}"
                else
                    VERSION="current.$(git rev-parse --short HEAD)"
                fi
                echo "version_tag=$VERSION" >> $GITHUB_OUTPUT
                echo "âœ… Version for current channel: $VERSION"
              shell: bash

            - name: Set final version
              id: version
              run: |
                if [ "${{ inputs.channel }}" = "current" ]; then
                    VERSION="${{ steps.current_version.outputs.version_tag }}"
                else
                    VERSION="${{ steps.download.outputs.version_tag }}"
                fi
                echo "tag=$VERSION" >> $GITHUB_OUTPUT
                echo "ðŸ·ï¸  Final version tag: $VERSION"
              shell: bash

            - name: Setup Arturo
              run: |
                sudo apt-get update
                sudo apt-get install -y libgtk-3-dev libmpfr-dev libwebkit2gtk-4.1-dev

                # Find and extract Linux AMD64 artifact
                LINUX_ZIP=$(ls files/arturo-*-linux-amd64.zip | head -1)
                
                if [ -z "$LINUX_ZIP" ]; then
                    echo "âŒ ERROR: Could not find Linux AMD64 binary"
                    ls -lah files/
                    exit 1
                fi
                
                echo "ðŸ“¦ Using: $(basename $LINUX_ZIP)"
                unzip -q "$LINUX_ZIP" -d /tmp/arturo
                
                chmod +x /tmp/arturo/arturo
                echo "/tmp/arturo" >> $GITHUB_PATH
                
                echo "âœ… Arturo installed:"
                /tmp/arturo/arturo --version
              shell: bash

            - name: Checkout examples repository
              uses: actions/checkout@v4
              with:
                repository: arturo-lang/examples
                path: examples

            - name: "Generate website"
              env:
                VERSION_TAG: ${{ steps.version.outputs.tag }}
                CHANNEL: ${{ inputs.channel }}
              run: |
                arturo tools/binarygen.art "$VERSION_TAG" "$CHANNEL"
                arturo tools/sitegen.art
                arturo tools/indexgen.art
                arturo tools/preprocessjs.art "$CHANNEL"

                mv details.art src/data/setup.art
                rm -rf tmpdocs
                mkdir -p tmpdocs
                cd src
                arturo ../tools/miniwebize/webize.art --build --at: ../tmpdocs
                cd ..
                mkdir -p tmpdocs/backend
                cp -r src/backend/* tmpdocs/backend/
                mkdir -p tmpdocs/scripts
                cp -r src/scripts/* tmpdocs/scripts

                arturo tools/tutorialgen.art tmpdocs
                
            - name: Copy binaries to website
              run: |
                mkdir -p tmpdocs/files
                echo "ðŸ“¦ Copying binaries..."
                cp files/*.zip tmpdocs/files/
                echo "${{ steps.version.outputs.tag }}" > tmpdocs/files/VERSION
                echo "âœ… Binaries in tmpdocs:"
                ls -lh tmpdocs/files/
                
            - name: Synchronize to website
              uses: burnett01/rsync-deployments@7.0.2
              with:
                switches: -avzr --delete
                path: tmpdocs/
                remote_path: /usr/local/www/arturo/main/versions/${{ inputs.channel }}
                remote_host: 188.245.97.105 
                remote_user: web
                remote_key: ${{ secrets.FREEBSD_DEPLOYMENT }}

            - name: Extract and move FreeBSD binary
              uses: appleboy/ssh-action@v1.2.0
              with:
                host: 188.245.97.105
                username: web
                key: ${{ secrets.FREEBSD_DEPLOYMENT }}
                script: |
                  cd /usr/local/www/arturo/main/versions/${{ inputs.channel }}
                
                  # Download examples
                  mkdir -p examples
                  curl -L https://github.com/arturo-lang/examples/archive/refs/heads/main.tar.gz | \
                      tar xz --strip-components=1 -C examples/

                  # Extract FreeBSD binary
                  unzip -o files/*-freebsd-amd64.zip
                  mkdir -p bin
                  mv arturo bin/
                  chmod +x scripts/setup_runner.sh
                  sudo /usr/local/sbin/arturo_setup_runner ${{ inputs.channel }}

            - name: Upload complete website artifact
              uses: 'actions/upload-artifact@v4'
              with:
                name: website-${{ inputs.channel }}-${{ steps.version.outputs.tag }}
                path: tmpdocs

            - name: Display completion summary
              run: |
                echo "ðŸŽ‰ Website Deployment Complete!"
                echo "======================================"
                echo "Channel:  ${{ inputs.channel }}"
                echo "Version:  ${{ steps.version.outputs.tag }}"
                echo "Binaries: $(ls files/*.zip | wc -l) files"
                echo "URL:      https://188.245.97.105/${{ inputs.channel }}"
                echo "======================================"